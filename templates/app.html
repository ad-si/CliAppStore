{% extends "base.html" %}
{% block main %}
  <div class="container mt-4">
    <div class="jumbotron py-4">
      <div class="row">
        <div class="col-sm-5 text-center">
          <img
            class="img-fluid"
            src="/apps/{{app.slug}}/main.png"
            alt="Screenshot of CLI app {{app.name}}"
          >
        </div>

        <div class="col-sm">
          <h1>{{app.name}}</h1>

          <p class="text-secondary">{{app.description}}</p>

          <p>By <a href="{{app.developer.website}}">{{app.developer.name}}</a>
          </p>

          <a href="/apps/{{app.slug}}/installation" class="d-none"></a>

          <form
            method="post"
            action="https://www.paypal.com/cgi-bin/webscr"
            class="mb-2"
          >
            <input type="hidden" name="business" value="adrian@feram.io">
            <input type="hidden" name="cmd" value="_xclick">
            <input type="hidden" name="item_name" value="{{app.name}}">
            <input type="hidden" name="amount" value="{{app.price}}">
            <input type="hidden" name="currency_code" value="EUR">
            <input type="hidden" name="image_url"
              value="https://pics.paypal.com/00/s/MjAwWDIwMFhQTkc/p/Y2Q4NGYzZWItZDI4Mi00NWQ3LTk4ZWUtNjgwMDdhMDJjMDk2/image_58.jpg">
            <input type="hidden" name="no_shipping" value="1">
            <input type="hidden" name="return"
              value="https://cliapp.store/apps/{{app.slug}}/installation">

            <button
              type="submit"
              class="btn font-weight-bold"
              style="background-color: #ffc439"
            >
              <span
                class="d-inline-block align-middle pr-2
                  border-right border-secondary"
              >
                <!-- Do not split over several lines (avoids whitesp. bugs) -->
                {{app.price}} €</span><span class="pl-2 align-middle">Buy with
                <svg
                  width="60"
                  height="18"
                  viewBox="0 0 100 32"
                  class="align-text-bottom position-relative"
                  style="bottom: 1px"
                >
                  <path
                    fill="#003087"
                    d="M12 5H4.2c-.5 0-1 .3-1.1.8L0 25.8c-.1.4.2.7.6.7h3.7c.5 0 1-.4 1.1-.9l.8-5.4a1 1 0 0 1 1.1-.9h2.5c5.1 0 8.1-2.5 8.9-7.4.3-2 0-3.8-1-5-1.1-1.3-3.1-2-5.7-2zm.9 7.2C12.5 15 10.3 15 8.3 15H7.1l.8-5.2c0-.3.3-.5.6-.5H9c1.4 0 2.7 0 3.4.8.5.4.7 1.1.5 2.1zM35.2 12.1h-3.7c-.3 0-.6.2-.6.5l-.2 1-.3-.4c-.8-1.2-2.6-1.6-4.4-1.6a8.6 8.6 0 0 0-8.3 7.5c-.4 2.2.1 4.3 1.4 5.7a6 6 0 0 0 4.7 2c3.3 0 5.2-2.2 5.2-2.2l-.2 1c-.1.4.2.8.6.8h3.4c.5 0 1-.4 1.1-.9l2-12.8c.1-.2-.3-.6-.7-.6zm-5.1 7.2c-.4 2.1-2 3.6-4.2 3.6-1.1 0-1.9-.3-2.5-1-.6-.7-.8-1.6-.6-2.6a4.2 4.2 0 0 1 4.2-3.6c1.1 0 1.9.4 2.5 1 .5.7.7 1.6.6 2.6zM55.1 12.1h-3.7a1 1 0 0 0-.9.5l-5.2 7.6-2.2-7.3c-.1-.5-.6-.8-1-.8h-3.7c-.4 0-.8.4-.6 1l4.1 12-3.9 5.4c-.3.4 0 1 .5 1h3.7c.4 0 .7-.2.9-.5l12.5-18c.3-.3 0-.9-.5-.9z"
                  />
                  <path
                    fill="#009cde"
                    d="M67.5 5h-7.8c-.5 0-1 .3-1.1.8l-3.1 20c-.1.3.2.6.6.6h4c.4 0 .7-.3.7-.6l.9-5.7a1 1 0 0 1 1.1-.9h2.5c5.1 0 8.1-2.5 8.9-7.4.3-2 0-3.8-1-5C72 5.6 70.1 5 67.5 5zm.9 7.2C68 15 65.8 15 63.8 15h-1.2l.8-5.2c0-.3.3-.5.6-.5h.5c1.4 0 2.7 0 3.4.8.5.4.6 1.1.5 2.1zM90.7 12.1H87c-.3 0-.6.2-.6.5l-.2 1-.3-.4c-.8-1.2-2.6-1.6-4.4-1.6a8.6 8.6 0 0 0-8.3 7.5c-.4 2.2.1 4.3 1.4 5.7a6 6 0 0 0 4.7 2c3.3 0 5.2-2.2 5.2-2.2l-.2 1c-.1.4.2.8.6.8h3.4c.5 0 1-.4 1.1-.9l2-12.8c0-.2-.3-.6-.7-.6zm-5.2 7.2c-.4 2.1-2 3.6-4.2 3.6-1.1 0-1.9-.3-2.5-1-.6-.7-.8-1.6-.6-2.6a4.2 4.2 0 0 1 4.2-3.6c1.1 0 1.9.4 2.5 1 .6.7.8 1.6.6 2.6zM95.1 5.4l-3.2 20.3c-.1.4.2.7.6.7h3.2c.5 0 1-.4 1.1-.9L100 5.6c.1-.4-.2-.7-.6-.7h-3.6c-.4 0-.6.2-.7.5z"
                  />
                </svg>
              </span>
            </button>

            <img alt="Tracking pixel" border="0" width="1" height="1"
              src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif"
            >
          </form>

          {% set license_terms = raw(app.license_terms
              | replace("\n\n", "</p><p>")) %}

          <div class="text-secondary">
            <small>
              <a href="#pricingModal"
                data-toggle="modal" class="text-secondary"
              >
                Pricing info
              </a>
              {% if app.has_free_trail %}
                <span> • </span>
                <a href="#trialModal"
                  data-toggle="modal" class="text-secondary"
                >
                  Free trial version
                </a>
              {% endif %}
            </small>
          </div>

          <div id="pricingModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Pricing Info</h5>
                  <button type="button" class="close"
                    data-dismiss="modal" aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p>The payment is composed of following parts:</p>
                  {% set value_vat = round(app.price * 0.19 * 100) / 100 %}
                  {% set value_net = app.price - value_vat %}
                  {% set value_store = round(value_net * 0.3 * 100) / 100 %}
                  {% set value_developer = value_net - value_store %}
                  <ul>
                    <li> 19 % ({{value_vat}} €) is German VAT</li>
                    <li>Of the remaining 81 % ({{value_net}} €)
                      <ul>
                        <li>
                          70 % ({{value_developer}} €)
                          go to the developer of the app
                          (<a href="{{app.developer.website}}">{{app.developer.name}}</a>).
                          This amount is not transferred immediately,
                          but aggregated until a threshold of 10 € is exceeded
                          to reduce transaction costs.
                        </li>
                        <li>
                          30 % ({{value_store}} €)
                          go to us (<a href="https://feram.io">Feram GmbH</a>)
                          in order to power this website and ensure a
                          sustainable development.
                        </li>
                      </ul>
                    </li>
                  </ul>
                  {{license_terms}}
                </div>
                <div class="modal-footer">
                  <button type="button"
                    class="btn btn-secondary" data-dismiss="modal"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="trialModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Free Trial Version</h5>
                  <button type="button" class="close"
                    data-dismiss="modal" aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p><strong>
                    You can try out {{app.name}} for free.
                    To use it regularly, you must buy a license.
                  </strong></p>
                  <p>{{license_terms}}</p>
                </p>
                </div>
                <div class="modal-footer">
                  <a
                    href="/apps/{{app.slug}}/installation"
                    class="btn btn-primary"
                  >
                    I understand, forward me to the download
                  </a>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>


    <div class="row mb-5">
      <div class="col">
        <h4>Screenshots</h4>

        <div class="container bg-secondary px-2 pt-2 rounded">
          <div
            id="screenshotsCarousel"
            class="carousel slide mb-2"
            data-ride="false"
          >
            <div class="carousel-inner">
              {% for screenshot in app.screenshots %}
                <div class="carousel-item
                  {% if loop.index == 1 %}active{% endif %}"
                >
                  <img
                    class="d-block mx-auto"
                    style="height: 20em"
                    src="/apps/{{app.slug}}/{{screenshot}}"
                    alt="Screenshot">
                </div>
              {% endfor %}
            </div>

            {% if length(app.screenshots) > 1 %}
              <a
                class="carousel-control-prev"
                href="#screenshotsCarousel"
                role="button"
                data-slide="prev"
              >
                <span class="carousel-control-prev-icon" aria-hidden="true">
                </span>
                <span class="sr-only">Previous</span>
              </a>

              <a
                class="carousel-control-next"
                href="#screenshotsCarousel"
                role="button"
                data-slide="next"
              >
                <span class="carousel-control-next-icon" aria-hidden="true">
                </span>
                <span class="sr-only">Next</span>
              </a>
            {% endif %}

          </div>

          <hr>

          <ol class="nav justify-content-around
                d-flex flex-row flex-wrap align-content-center"
          >
            {% for screenshot in app.screenshots %}
              <li
                class="nav-item {% if loop.index == 1 %}active{% endif %}"
                data-target="#screenshotsCarousel"
                data-slide-to="{{loop.index0}}"
              >
                <img
                  class="mb-2"
                  style="height: 5em"
                  src="/apps/{{app.slug}}/{{screenshot}}"
                  alt="Screenshot"
                >
              </li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>

    <div class="row mb-5">
      <div class="col">
        <h4 class="mb-3">Description</h4>

        <p>{{app.description_long | markdown}}</p>
      </div>

      <div class="col">
        <h4 class="mb-3">Information</h4>

        <table class="table table-borderless">
          <tbody>
            <tr>
              <th scope="row">Tags</th>
              <td>
                {% for tag in app.tags %}
                  <span class="badge badge-pill badge-info">{{tag}}</span>
                {% endfor %}
              </td>
            </tr>
            <tr>
              <th scope="row">Version</th>
              <td>{{app.changelog[0].version}}</td>
            </tr>
            <tr>
              <th scope="row">Price</th>
              <td>{{app.price}} €</td>
            </tr>
            <tr>
              <th scope="row">App Website</th>
              <td><a href="{{app.website}}">{{app.website}}</a></td>
            </tr>
            <tr>
              <th scope="row">Sourcecode</th>
              <td><a href="{{app.code}}">{{app.code}}</a></td>
            </tr>
            <tr>
              <th scope="row">Developer Website</th>
              <td><a href="{{app.developer.website}}">
                {{app.developer.website}}
              </a></td>
            </tr>
            <tr>
              <th scope="row">License</th>
              <td><a href="{{app.license.url}}">
                {{app.license.name}}
              </a></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <h4 class="mb-3">Changelog</h4>

        <p>
          For more details, check out the
          <a href="{{app.changelog_url}}">external changelog</a>.
        </p>

        <ol class="list-unstyled">
          {% for release in app.changelog %}
            <li
              class="my-2 pt-3 border-top
                {% if loop.index != 1 %}
                  collapse is-collapsible
                {% endif %}"
            >
              <h5>{{app.name}} <small>{{release.version}}</small></h5>
              <p>
                <small class="text-secondary">
                  {% if release.url %}<a href="{{release.url}}">{% endif %}
                    Released on {{release.utc}}
                  {% if release.url %}</a>{% endif %}
                </small>
              </p>

              {% if release.changes %}
                <ul
                  class="text-secondary"
                  style="list-style-type: disc"
                >
                  {% for change in release.changes %}
                    <li>{{change}}</li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="text-secondary">
                  {{release.description | markdown}}
                </div>
              {% endif %}
            </li>
          {% endfor %}
          <li>
            <hr>
            <a class="d-block" data-toggle="collapse" href=".is-collapsible,#show-more,#show-less">
              <div id="show-less" class="collapse">
                Less <span style="font-size: 0.7em">▲</span>
              </div>
              <div id="show-more" class="collapse show">
                Older Versions <span style="font-size: 0.7em">▼</span>
              </div>
            </a>
          </li>
        </ol>
      </div>

      <div class="col">
        <h4 class="mb-3">Similar Apps</h4>

        <ul class="list-unstyled">
          {% for similarApp in app.similar %}
            <li class="media">
              {% if similarApp.slug %}
                <a href="/apps/{{similarApp.slug}}">
                  <img
                    src="/apps/{{similarApp.slug}}/main.png"
                    alt="Image of app"
                    class="mr-3"
                    style="max-width: 8em"
                  >
                </a>
              {% else %}
                <a href="{{similarApp.url}}">
                  <img
                    src="/images/app.svg"
                    width="48px"
                    height="48px"
                    alt="Image of app"
                    class="mr-3"
                    style="max-width: 8em"
                  >
                </a>
              {% endif %}
              <div class="media-body">
                {% if similarApp.slug %}
                  <a class="text-dark" href="/apps/{{similarApp.slug}}">
                    <h5 class="mt-0 mb-1">{{similarApp.name}}</h5>
                  </a>
                {% else %}
                  <a class="text-dark" href="{{similarApp.url}}">
                    <h5 class="mt-0 mb-1">{{similarApp.name}}</h5>
                  </a>
                {% endif %}
                <p>{{similarApp.description}}</p>
              </div>
              </a>
            </li>
          {% else %}
            <p class="text-secondary">
              There are no similar apps available yet.
            </p>
            <a href="{{submit_url}}" class="btn btn-light">Submit One</a>
          {% endfor %}
        </ul>
      </div>
    </div>

  </div>
{% endblock %}
